<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§ã‚¦ã‚§ãƒ“ãƒŠãƒ¼å‚åŠ ãŒå¯èƒ½ã«ï¼</title>

  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet"/>

  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/versions/2.22.0/sdk.js"></script>

  <style>
    html { scroll-behavior: smooth; }

    .segmented { display: flex; gap: 10px; }
    .segmented input[type="radio"] { display: none; }
    .segmented-btn {
      padding: 8px 14px; border: 2px solid var(--supplementary-beige);
      border-radius: 10px; cursor: pointer; user-select: none;
      font-weight: 600; font-size: 14px;
    }
    .segmented input[type="radio"]:checked + .segmented-btn {
      background: #FAE2D8;
      border-color: #FAE2D8;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --primary-color: #3A0407;
      --secondary-indigo: #7373E3;
      --secondary-light-blue: #77A9F7;
      --supplementary-sand: #AE8C6F;
      --supplementary-beige: #DAC9BB;
      --supplementary-mist: #F5F1EE;
    }

    @font-face {
      font-family: 'GaramondNarrowBookITC';
      src: local('Garamond'), local('Garamond Narrow');
      font-weight: normal;
      font-style: normal;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: linear-gradient(135deg, var(--supplementary-mist) 0%, #ffffff 100%);
      min-height: 100vh;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(58, 4, 7, 0.1);
      overflow: hidden;
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(30px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, #5A0A0F 100%);
      color: #fff;
      padding: 40px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute; top: -50%; right: -50%;
      width: 200%; height: 200%;
      background: radial-gradient(circle, rgba(115,115,227,0.1) 0%, transparent 70%);
      animation: pulse 15s infinite;
    }

    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }

    .logo-container {
      width: 80px; height: 80px; margin: 0 auto 20px;
      background: rgba(255,255,255,0.1);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(10px);
      position: relative; z-index: 1;
      transition: transform .3s ease;
    }
    .logo-container:hover { transform: scale(1.05); }
    .logo-container img { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; }

    .sub-header { font-size: 14px; color: var(--supplementary-beige); margin-bottom: 10px; position: relative; z-index: 1; letter-spacing: .5px; }
    h1 { font-size: 24px; font-weight: 700; margin-bottom: 15px; position: relative; z-index: 1; text-shadow: 2px 2px 4px rgba(0,0,0,.2); }
    .header-description { font-size: 13px; color: var(--supplementary-mist); position: relative; z-index: 1; line-height: 1.6; }

    .form-container { padding: 40px 30px; }

    .section-title {
      background: linear-gradient(90deg, var(--secondary-indigo), var(--secondary-light-blue));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      font-size: 18px; font-weight: 600; text-align: center; margin-bottom: 30px;
    }

    .form-group { margin-bottom: 25px; animation: fadeIn .5s ease-out forwards; opacity: 0; }
    .form-group:nth-child(1){animation-delay:.1s}.form-group:nth-child(2){animation-delay:.15s}
    .form-group:nth-child(3){animation-delay:.2s}.form-group:nth-child(4){animation-delay:.25s}
    .form-group:nth-child(5){animation-delay:.3s}.form-group:nth-child(6){animation-delay:.35s}
    .form-group:nth-child(7){animation-delay:.4s}.form-group:nth-child(8){animation-delay:.45s}
    @keyframes fadeIn { to { opacity: 1; } }

    label { display:block; font-size:14px; color:var(--primary-color); margin-bottom:8px; font-weight:500; }
    .english-text { font-family: 'GaramondNarrowBookITC','Garamond',serif; }

    input[type="text"], input[type="email"], input[type="tel"], select {
      width: 100%; padding: 12px 15px; border: 2px solid var(--supplementary-beige); border-radius: 10px;
      font-size: 15px; font-family: 'Noto Sans JP', sans-serif; transition: all .3s ease; background: #fff;
    }
    input:focus, select:focus {
      outline: none; border-color: var(--secondary-indigo);
      box-shadow: 0 0 0 4px rgba(115,115,227,.1); transform: translateY(-2px);
    }
    /* å…¥åŠ›ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    input.input-error {
      border-color: #d32f2f !important;
      background-color: #fdf2f2 !important;
      box-shadow: 0 0 0 4px rgba(211, 47, 47, 0.1) !important;
    }
    select {
      cursor: pointer; appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233A0407' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat; background-position: right 10px center; background-size: 20px; padding-right: 40px;
    }

    .checkbox-group {
      display: flex; align-items: flex-start; margin-top: 30px; padding: 20px;
      background: linear-gradient(135deg, var(--supplementary-mist) 0%, rgba(245,241,238,.3) 100%);
      border-radius: 12px; border: 1px solid var(--supplementary-beige);
    }
    input[type="checkbox"] { width: 20px; height: 20px; margin-right: 12px; margin-top: 2px; cursor: pointer; flex-shrink: 0; accent-color: var(--secondary-indigo); }
    .checkbox-label { font-size: 13px; color: #555; line-height: 1.6; }

    .submit-button {
      width: 100%; padding: 16px;
      background: linear-gradient(135deg, var(--secondary-indigo) 0%, var(--secondary-light-blue) 100%);
      color: #fff; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all .3s ease;
      margin-top: 30px; position: relative; overflow: hidden;
    }
    .submit-button::before {
      content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0;
      background: rgba(255,255,255,.3); border-radius: 50%;
      transform: translate(-50%,-50%); transition: width .6s, height .6s;
    }
    .submit-button:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(115,115,227,.3); }
    .submit-button:hover::before { width: 300px; height: 300px; }
    .submit-button:active { transform: translateY(-1px); }
    .submit-button:disabled { opacity: .6; cursor: not-allowed; }

    .error-message { color: #d32f2f; font-size: 12px; margin-top: 5px; display: none; }
    .error-message.show { display: block; animation: shake .3s ease-in-out; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }

    .loading {
      display:inline-block; width:20px; height:20px;
      border:3px solid rgba(255,255,255,.3); border-radius:50%;
      border-top-color:#fff; animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }

    /* é›»è©±ç•ªå·ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .phone-input-container { display: flex; gap: 10px; }
    .country-select { width: 130px; flex-shrink: 0; }
    
    @media (max-width: 600px) {
      .container { border-radius: 0; }
      body { padding: 0; }
      .header { padding: 30px 20px; }
      .form-container { padding: 30px 20px; }
      h1 { font-size: 20px; }
      
      .phone-input-container { gap: 8px; }
      .country-select { width: 110px; }
    }

    /* --- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè­¦å‘Šç”¨ï¼‰ --- */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); z-index: 9999;
      display: none; align-items: center; justify-content: center;
      padding: 20px;
    }
    .modal-overlay.show { display: flex; animation: fadeIn 0.3s; }
    .modal-content {
      background: #fff; padding: 25px; border-radius: 12px;
      max-width: 400px; width: 100%; text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .modal-title { font-weight: bold; font-size: 18px; margin-bottom: 10px; color: var(--primary-color); }
    .modal-body { font-size: 14px; color: #333; margin-bottom: 20px; line-height: 1.6; text-align: left; }
    .ua-box {
      background: #f0f0f0; padding: 10px; border-radius: 6px;
      font-family: monospace; font-size: 11px; word-break: break-all;
      margin: 10px 0; border: 1px solid #ccc; select-all: text;
    }
    .modal-buttons { display: flex; gap: 10px; justify-content: center; }
    .btn-retry { background: var(--secondary-indigo); color: white; border:none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
    .btn-force { background: #999; color: white; border:none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo-container">
        <img src="https://a.storyblok.com/f/64062/3240x3240/0cd4bdeacb/social-account-logo.png" alt="Crimson Education Logo"/>
      </div>
      <div class="sub-header">ã‚¯ã‚¤ãƒƒã‚¯ã‚¦ã‚§ãƒ“ãƒŠãƒ¼æ©Ÿèƒ½ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  ğŸš€</div>
      <div class="header-description">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«å›ç­”ã™ã‚‹ã“ã¨ã§</div>
      <div class="header-description">âœ… ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§ã‚¦ã‚§ãƒ“ãƒŠãƒ¼ç™»éŒ²ãŒå¯èƒ½ã« </div>
      <div class="header-description">âœ… èˆˆå‘³ã‚„çŠ¶æ³ã«åˆã‚ã›ã¦ã€å¿…è¦ãªæƒ…å ±ã ã‘ã‚’ãŠå±Šã‘</div>
      <div class="header-description">âœ… ç„¡æ–™ã®ã‚¬ã‚¤ãƒ‰ãƒ–ãƒƒã‚¯ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ</div>
    </div>

    <div class="form-container">
    <form id="registrationForm">
      <h2 class="section-title">ç”Ÿå¾’æ§˜ã®ã”çŠ¶æ³ã«ã¤ã„ã¦</h2>

      <div class="form-group">
          <label for="schoolType">ç”Ÿå¾’æ§˜ãŒç¾åœ¨é€šã‚ã‚Œã¦ã„ã‚‹å­¦æ ¡ã®ã‚¿ã‚¤ãƒ—ã‚’ã”é¸æŠãã ã•ã„ã€‚</label>
          <select id="schoolType" name="schoolType" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="Domestic_Intl">å›½å†…ã‚¤ãƒ³ã‚¿ãƒ¼</option>
            <option value="Domestic_Ja_Cur">å›½å†…å…¬ç§ç«‹(æ—¥æœ¬èªã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ )</option>
            <option value="Domestic_Intl_Cur">å›½å†…å…¬ç§ç«‹(å›½éš›ã‚«ãƒªã‚­ãƒ¥ãƒ©ãƒ )</option>
            <option value="Overseas">æµ·å¤–å­¦æ ¡</option>
          </select>
          <div class="error-message" id="schoolTypeError">å­¦æ ¡ã®ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <div class="form-group">
          <label for="graduationYear">ç”Ÿå¾’æ§˜ã”æœ¬äººã®2025å¹´9æœˆæ™‚ç‚¹ã§ã®å­¦å¹´ã‚’ã”é¸æŠãã ã•ã„ã€‚</label>
          <select id="graduationYear" name="graduationYear" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="2026">Grade 12ï¼ˆé«˜3ï¼‰</option>
            <option value="2027">Grade 11ï¼ˆé«˜2ï¼‰</option>
            <option value="2028">Grade 10ï¼ˆé«˜1ï¼‰</option>
            <option value="2029">Grade 9ï¼ˆä¸­3ï¼‰</option>
            <option value="2030">Grade 8ï¼ˆä¸­2ï¼‰</option>
            <option value="2031">Grade 7ï¼ˆä¸­1ï¼‰</option>
            <option value="2032">Grade 6ï¼ˆå°6ï¼‰</option>
            <option value="2033">Grade 5ï¼ˆå°5ï¼‰</option>
            <option value="2034">Grade 4ï¼ˆå°4ï¼‰</option>
            <option value="2035">Grade 3ï¼ˆå°3ï¼‰</option>
            <option value="2036">Grade 2ï¼ˆå°2ï¼‰</option>
            <option value="2037">Grade 1ï¼ˆå°1ï¼‰</option>
            <option value="Already Graduated">Already Graduated(ç¤¾ä¼šäºº)</option>
          </select>
          <div class="error-message" id="graduationYearError">å­¦å¹´ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <input type="hidden" id="lineDisplayName" name="lineDisplayName" value="" />        
      <div class="form-group">
          <label for="school"><span class="english-text">Enter student's current school</span>ï¼ˆå­¦æ ¡åãƒ»ã”æ‰€å±ã‚’ã”è¨˜å…¥ãã ã•ã„ï¼‰*ç”Ÿå¾’æ§˜ã®å­¦æ ¡ã‚’ã”è¨˜å…¥ãã ã•ã„ </label>
          <input type="text" id="school" name="school" required/>
          <div class="error-message" id="schoolError">å­¦æ ¡åãƒ»ã”æ‰€å±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>

      <div class="form-group">
          <label for="englishLevel"><span class="english-text">English Level</span> (è‹±èªåŠ›)</label>
          <select id="englishLevel" name="englishLevel" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="C2">C2/Native Proficiency</option>
            <option value="C1">C1/Advanced (TOEFL95+/IELTS7.0/è‹±æ¤œ1ç´š)</option>
            <option value="B2">B2/Upper Intermediate (TOEFL72+/IELTS5.5/è‹±æ¤œæº–1ç´š)</option>
            <option value="B1">B1/Intermediate (TOEFL42+/IELTS4.0+/è‹±æ¤œ2ç´š)</option>
            <option value="A2">A2/Pre Intermediate (è‹±æ¤œæº–2ç´š)</option>
            <option value="A1">A1/Elementary (è‹±æ¤œ3ç´š)</option>
            <option value="A0">A0/Elementary (è‹±æ¤œ4ç´šä»¥ä¸‹)</option>
            <option value="C2">è³‡æ ¼ãªã—ï¼ˆæµ·å¤–åœ¨ä½çµŒé¨“ã‚ã‚Š/å¹¼ç¨šåœ’ãŒã‚¤ãƒ³ã‚¿ãƒ¼/å¸°å›½ç”Ÿï¼‰</option>
          </select>
          <div class="error-message" id="englishLevelError">è‹±èªåŠ›ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <div class="form-group" id="desiredCountriesGroup">
          <label>ç”Ÿå¾’æ§˜ãŒæ¤œè¨ã—ã¦ã„ã‚‹é€²å­¦å…ˆã‚’ã”é¸æŠãã ã•ã„ï¼ˆè¤‡æ•°å¯ï¼‰</label>
          <div>
            <label><input type="checkbox" name="desiredCountries" value="US" /> ã‚¢ãƒ¡ãƒªã‚«</label><br/>
            <label><input type="checkbox" name="desiredCountries" value="UK" /> ã‚¤ã‚®ãƒªã‚¹</label><br/>
            <label><input type="checkbox" name="desiredCountries" value="Other" /> ã‚«ãƒŠãƒ€/ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢/EU/ãã®ä»–</label><br/>
            <label><input type="checkbox" name="desiredCountries" value="Undecided" id="desiredUndecided" /> ã¾ã æ±ºã¾ã£ã¦ã„ãªã„</label>
          </div>
          <div class="error-message" id="desiredCountriesError">å°‘ãªãã¨ã‚‚1ã¤é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <h2 class="section-title">ã‚ãªãŸã”è‡ªèº«ã«ã¤ã„ã¦</h2>

      <div class="form-group">
          <label>Are you a Student or Guardian:ï¼ˆä¿è­·è€… or ç”Ÿå¾’ï¼‰</label>
          <div class="segmented" id="studentGuardianGroup">
            <input type="radio" id="roleStudent" name="studentOrGuardian" value="Student" required/>
            <label for="roleStudent" class="segmented-btn">Studentï¼ˆç”Ÿå¾’ï¼‰</label>

            <input type="radio" id="roleGuardian" name="studentOrGuardian" value="Guardian"/>
            <label for="roleGuardian" class="segmented-btn">Guardianï¼ˆä¿è­·è€…ï¼‰</label>
          </div>
          <div class="error-message" id="studentOrGuardianError">ç”Ÿå¾’/ä¿è­·è€…ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <div class="form-group">
          <label for="firstName"><span class="english-text">First Name</span>ï¼ˆåï¼‰*è¨˜å…¥è€…ã”æœ¬äººã®ãŠåå‰<br><span style="font-size:12px; color:var(--secondary-indigo);">â€»ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã§ã”è¨˜å…¥ãã ã•ã„</span></label>
          <input type="text" id="firstName" name="firstName" placeholder="Taro" required/>
          <div class="error-message" id="firstNameError">åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
          <div class="error-message" id="firstNameAlphaError">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>

      <div class="form-group">
          <label for="lastName"><span class="english-text">Last Name</span>ï¼ˆå§“ï¼‰*è¨˜å…¥è€…ã”æœ¬äººã®ãŠåå‰<br><span style="font-size:12px; color:var(--secondary-indigo);">â€»ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã§ã”è¨˜å…¥ãã ã•ã„</span></label>
          <input type="text" id="lastName" name="lastName" placeholder="Yamada" required/>
          <div class="error-message" id="lastNameError">å§“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
          <div class="error-message" id="lastNameAlphaError">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>

      <div class="form-group">
          <label for="email"><span class="english-text">Email Address</span>ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰</label>
          <input type="email" id="email" name="email" required/>
          <div class="error-message" id="emailError">æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
        
      <div class="form-group">
          <label for="phone"><span class="english-text">Phone Number</span>ï¼ˆé›»è©±ç•ªå·ï¼‰</label>
          <div class="phone-input-container">
            <select id="countryCode" name="countryCode" class="country-select">
              <option value="+81" selected>ğŸ‡¯ğŸ‡µ +81</option>
              <option value="+1">ğŸ‡ºğŸ‡¸ +1</option>
              <option value="+61">ğŸ‡¦ğŸ‡º +61</option>
              <option value="+44">ğŸ‡¬ğŸ‡§ +44</option>
              <option value="+86">ğŸ‡¨ğŸ‡³ +86</option>
              <option value="+65">ğŸ‡¸ğŸ‡¬ +65</option>
              <option value="+82">ğŸ‡°ğŸ‡· +82</option>
              <option value="">Other</option>
            </select>
            <input type="tel" id="phone" name="phone" placeholder="9012345678" required/>
          </div>
          <div class="error-message" id="phoneError">é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>

      <div class="form-group">
          <label for="prefecture"><span class="english-text">Prefecture</span>ï¼ˆãŠä½ã¾ã„ã®åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„ï¼‰*ãŠè¿‘ãã§å®Ÿæ–½ã•ã‚Œã‚‹å¯¾é¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’å„ªå…ˆçš„ã«ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚</label>
          <select id="prefecture" name="prefecture" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            <option value="Hokkaido">åŒ—æµ·é“</option>
            <option value="Aomori">é’æ£®çœŒ</option>
            <option value="Iwate">å²©æ‰‹çœŒ</option>
            <option value="Miyagi">å®®åŸçœŒ</option>
            <option value="Akita">ç§‹ç”°çœŒ</option>
            <option value="Yamagata">å±±å½¢çœŒ</option>
            <option value="Fukushima">ç¦å³¶çœŒ</option>
            <option value="Ibaraki">èŒ¨åŸçœŒ</option>
            <option value="Tochigi">æ ƒæœ¨çœŒ</option>
            <option value="Gunma">ç¾¤é¦¬çœŒ</option>
            <option value="Saitama">åŸ¼ç‰çœŒ</option>
            <option value="Chiba">åƒè‘‰çœŒ</option>
            <option value="Tokyo">æ±äº¬éƒ½</option>
            <option value="Kanagawa">ç¥å¥ˆå·çœŒ</option>
            <option value="Niigata">æ–°æ½ŸçœŒ</option>
            <option value="Toyama">å¯Œå±±çœŒ</option>
            <option value="Ishikawa">çŸ³å·çœŒ</option>
            <option value="Fukui">ç¦äº•çœŒ</option>
            <option value="Yamanashi">å±±æ¢¨çœŒ</option>
            <option value="Nagano">é•·é‡çœŒ</option>
            <option value="Gifu">å²é˜œçœŒ</option>
            <option value="Shizuoka">é™å²¡çœŒ</option>
            <option value="Aichi">æ„›çŸ¥çœŒ</option>
            <option value="Mie">ä¸‰é‡çœŒ</option>
            <option value="Shiga">æ»‹è³€çœŒ</option>
            <option value="Kyoto">äº¬éƒ½åºœ</option>
            <option value="Osaka">å¤§é˜ªåºœ</option>
            <option value="Hyogo">å…µåº«çœŒ</option>
            <option value="Nara">å¥ˆè‰¯çœŒ</option>
            <option value="Wakayama">å’Œæ­Œå±±çœŒ</option>
            <option value="Tottori">é³¥å–çœŒ</option>
            <option value="Shimane">å³¶æ ¹çœŒ</option>
            <option value="Okayama">å²¡å±±çœŒ</option>
            <option value="Hiroshima">åºƒå³¶çœŒ</option>
            <option value="Yamaguchi">å±±å£çœŒ</option>
            <option value="Tokushima">å¾³å³¶çœŒ</option>
            <option value="Kagawa">é¦™å·çœŒ</option>
            <option value="Ehime">æ„›åª›çœŒ</option>
            <option value="Kochi">é«˜çŸ¥çœŒ</option>
            <option value="Fukuoka">ç¦å²¡çœŒ</option>
            <option value="Saga">ä½è³€çœŒ</option>
            <option value="Nagasaki">é•·å´çœŒ</option>
            <option value="Kumamoto">ç†Šæœ¬çœŒ</option>
            <option value="Oita">å¤§åˆ†çœŒ</option>
            <option value="Miyazaki">å®®å´çœŒ</option>
            <option value="Kagoshima">é¹¿å…å³¶çœŒ</option>
            <option value="Okinawa">æ²–ç¸„çœŒ</option>
            <option value="USA/CA">ç±³å›½ãƒ»ã‚«ãƒŠãƒ€</option>
            <option value="Singapore">ã‚·ãƒ³ã‚¬ãƒãƒ¼ãƒ«</option>
            <option value="Other_Region">ä¸Šè¨˜ä»¥å¤–</option>
          </select>
          <div class="error-message" id="prefectureError">ãŠä½ã¾ã„ã®åœ°åŸŸã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>

      <div class="checkbox-group">
          <input type="checkbox" id="privacy" name="privacy" required/>
          <label for="privacy" class="checkbox-label">
            By providing your phone number above, and pressing the "Submit" button below, you agree to receive automated text messages from Crimson, Inc. and also agree to
            <a href="https://www.crimsoneducation.org/us/privacy-policy/" target="_blank" style="color: var(--secondary-indigo); text-decoration: underline;">the privacy policyï¼ˆãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã™ã‚‹ã€‚Crimson Educationã‹ã‚‰LINEã€SMSãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã«åŒæ„ã™ã‚‹ã€‚ï¼‰
          </label>
      </div>
      <div class="error-message" id="privacyError">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¦ãã ã•ã„</div>

      <button type="submit" class="submit-button" id="submitBtn">é€ä¿¡ã™ã‚‹</button>
    </form>
    </div>
  </div>

  <div id="errorModal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-title">âš ï¸ LINE ID èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>
        <div class="modal-body">
          LINE IDã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>
          ã“ã®ã¾ã¾é€ä¿¡ã™ã‚‹ã¨ã€ä¸€éƒ¨æ©Ÿèƒ½ï¼ˆã‚¦ã‚§ãƒ“ãƒŠãƒ¼è‡ªå‹•ç™»éŒ²ãªã©ï¼‰ãŒæ­£å¸¸ã«å‹•ä½œã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
          
          <div style="margin: 15px 0; font-size: 13px; line-height: 1.8;">
            1. <strong>"å†èª­ã¿è¾¼ã¿ã‚’è©¦ã™"</strong> ã‚’æŠ¼ã—ã€å†åº¦é€ä¿¡ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚<br>
            2. å†åº¦è¡¨ç¤ºã•ã‚Œã‚‹å ´åˆã¯ã€<strong>ã“ã®ç”»é¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±</strong>ã®ä¸Šã€<strong>"é€ä¿¡ã™ã‚‹"</strong> ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
            3. ä¸å…·åˆãŒç¶šãå ´åˆã¯ LINE ã‹ã‚‰ã”é€£çµ¡ãã ã•ã„ã€‚æ‹…å½“è€…ãŒå¯¾å¿œã„ãŸã—ã¾ã™ã€‚
          </div>
  
          <strong>æ‹…å½“è€…ã¸ã®é€£çµ¡ç”¨æƒ…å ±:</strong>
          <div class="ua-box" id="uaContent"></div>
          </div>
        <div class="modal-buttons">
          <button type="button" class="btn-force" id="forceSubmitBtn">é€ä¿¡ã™ã‚‹</button>
          <button type="button" class="btn-retry" id="retryBtn">å†èª­ã¿è¾¼ã¿ã‚’è©¦ã™</button>
        </div>
      </div>
    </div>

  <script>
    // ====== è¨­å®š ======
    const LIFF_ID = "2007173778-lxg3MkX5";
    const TY_BASE = "https://www.crimsoneducation.org/ja/thank-you/line-quick-wb-ty"; 
    const SECONDARY_ENDPOINT = "https://script.google.com/macros/s/AKfycbxlGfCGSX8Eb_bIEbej7rD0FzPEO_jyola__er_8ajYTIUvhFbVXG-86p8Oef2ckoip/exec"; 

    // ====== ãƒ‡ãƒ¼ã‚¿ä¿æŒï¼ˆã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–ï¼†ãƒ­ãƒ¼ãƒ‰ï¼‰æ©Ÿèƒ½ ======
    const FORM_STORAGE_KEY = "crimson_form_backup";

    function saveAndReload() {
      const formData = {};
      document.querySelectorAll("input[type=text], input[type=email], input[type=tel], input[type=hidden], select").forEach(el => {
        if (el.name) formData[el.name] = el.value;
      });
      const checkedBoxes = {};
      document.querySelectorAll("input[type=checkbox]:checked").forEach(el => {
        if (!checkedBoxes[el.name]) checkedBoxes[el.name] = [];
        checkedBoxes[el.name].push(el.value);
      });
      formData["_checkboxes"] = checkedBoxes;
      
      const radios = document.querySelector("input[type=radio]:checked");
      if (radios) formData[radios.name] = radios.value;

      sessionStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(formData));
      location.reload();
    }

    function restoreFormData() {
      const savedJson = sessionStorage.getItem(FORM_STORAGE_KEY);
      if (!savedJson) return;

      try {
        const data = JSON.parse(savedJson);
        for (const [key, value] of Object.entries(data)) {
          if (key === "_checkboxes") continue;
          const el = document.querySelector(`[name="${key}"]`);
          if (!el) continue;

          if (el.type === "radio") {
            const targetRadio = document.querySelector(`input[name="${key}"][value="${value}"]`);
            if (targetRadio) targetRadio.checked = true;
          } else {
            el.value = value;
          }
        }
        if (data._checkboxes) {
          for (const [name, values] of Object.entries(data._checkboxes)) {
            values.forEach(val => {
              const cb = document.querySelector(`input[name="${name}"][value="${val}"]`);
              if (cb) cb.checked = true;
            });
          }
        }
        sessionStorage.removeItem(FORM_STORAGE_KEY);
      } catch (e) {
        console.warn("ãƒ‡ãƒ¼ã‚¿å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ", e);
      }
    }

    // ====== LIFF åˆæœŸåŒ– ======
    async function initLIFF() {
      if (typeof liff === "undefined") return;
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isInClient() && !liff.isLoggedIn()) {
          liff.login({ redirectUri: location.href });
          return false;
        }
        try {
          const profile = await liff.getProfile().catch(() => null);
          const dn = profile?.displayName || "";
          const dnInput = document.getElementById("lineDisplayName");
          if (dnInput) dnInput.value = dn;
        } catch {}
        return true;
      } catch (e) {
        console.warn("LIFF initialization failed:", e);
        return false;
      }
    }

    // ====== ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ² ======
    function setupDesiredCountryLogic() {
      const boxes = Array.from(document.querySelectorAll('input[name="desiredCountries"]'));
      const undecided = document.getElementById('desiredUndecided');
      if (!boxes.length) return;

      function handleChange(e) {
        const checked = boxes.filter(b => b.checked);
        const err = document.getElementById('desiredCountriesError');
        if (checked.length > 0 && err) err.classList.remove('show');

        if (e && e.target === undecided && undecided.checked) {
          boxes.forEach(b => { if (b !== undecided) b.checked = false; });
        } else if (e && e.target !== undecided && e.target.checked) {
          if (undecided) undecided.checked = false;
        }
      }
      boxes.forEach(b => b.addEventListener('change', handleChange));
    }

    window.addEventListener('DOMContentLoaded', setupDesiredCountryLogic);
    window.addEventListener('DOMContentLoaded', initLIFF);
    window.addEventListener('DOMContentLoaded', restoreFormData); // å¾©å…ƒå‡¦ç†

    // åå‰ï¼ˆã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆï¼‰ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
    const nameFields = ['firstName', 'lastName'];
    const alphaRegex = /^[a-zA-Z\s\-\.]+$/;

    nameFields.forEach(id => {
      const input = document.getElementById(id);
      const errorMsg = document.getElementById(id + "AlphaError");
      if (!input || !errorMsg) return;

      input.addEventListener('input', function() {
        const val = input.value;
        if (val === "") {
          input.classList.remove("input-error");
          errorMsg.classList.remove("show");
          return;
        }
        if (!alphaRegex.test(val)) {
          input.classList.add("input-error");
          errorMsg.classList.add("show");
        } else {
          input.classList.remove("input-error");
          errorMsg.classList.remove("show");
        }
      });
    });

    // ====== ãƒ‡ãƒ¼ã‚¿é€ä¿¡ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ======
    function sendPayloadToSecondaryEndpoint(payload) {
      const params = new URLSearchParams();
      params.set("payload", JSON.stringify(payload));
      
      let sent = false;
      try {
        if (navigator.sendBeacon) {
          const data = new Blob(
            [params.toString()],
            { type: "application/x-www-form-urlencoded;charset=UTF-8" }
          );
          sent = navigator.sendBeacon(SECONDARY_ENDPOINT, data);
        }
      } catch(e) { console.warn(e); }

      if (!sent) {
        fetch(SECONDARY_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
          body: params.toString(),
          keepalive: true,
          redirect: "follow"
        }).catch(() => {});
      }
    }

    function redirectToThankYouPage(payload) {
       const qs = "payload=" + encodeURIComponent(JSON.stringify(payload));
       window.location.assign(TY_BASE + "?" + qs);
    }

    // ====== ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡åˆ¶å¾¡ ======
    const form = document.getElementById("registrationForm");
    const submitBtn = document.getElementById("submitBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      // --- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ ---
      document.querySelectorAll(".error-message").forEach(el => el.classList.remove("show"));
      let isValid = true;
      let scrolledToError = false;

      const fields = [
        { id: "firstName", errorId: "firstNameError" },
        { id: "lastName",  errorId: "lastNameError"  },
        { id: "email",     errorId: "emailError"     },
        { id: "phone",     errorId: "phoneError"     },
        { id: "school",    errorId: "schoolError"    },
        { id: "graduationYear", errorId: "graduationYearError" },
        { id: "englishLevel",   errorId: "englishLevelError"   },
        { id: "schoolType",     errorId: "schoolTypeError"     },
        { id: "prefecture",   errorId: "prefectureError"   },
      ];

      const sgSelected = document.querySelector('input[name="studentOrGuardian"]:checked');
      if (!sgSelected) {
        document.getElementById("studentOrGuardianError").classList.add("show");
        const sgAnchor = document.getElementById("studentGuardianGroup");
        if (sgAnchor && !scrolledToError) {
          sgAnchor.scrollIntoView({ behavior: "smooth", block: "start" });
          scrolledToError = true;
        }
        isValid = false;
      }

      fields.forEach(({ id, errorId }) => {
        const input = document.getElementById(id);
        if (!input || !input.value.trim()) {
          document.getElementById(errorId)?.classList.add("show");
          isValid = false;
        }
      });
      // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆé€ä¿¡æ™‚æœ€çµ‚ç¢ºèªï¼‰
      if (document.getElementById("firstName").value && !alphaRegex.test(document.getElementById("firstName").value)) {
        document.getElementById("firstNameAlphaError").classList.add("show");
        isValid = false;
      }
      if (document.getElementById("lastName").value && !alphaRegex.test(document.getElementById("lastName").value)) {
        document.getElementById("lastNameAlphaError").classList.add("show");
        isValid = false;
      }

      // Email
      const emailVal = document.getElementById("email").value;
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (emailVal && !emailRegex.test(emailVal)) {
        document.getElementById("emailError").classList.add("show");
        isValid = false;
      }

      // Desired Countries
      const desiredChecked = document.querySelectorAll('input[name="desiredCountries"]:checked');
      if (!desiredChecked.length) {
        document.getElementById("desiredCountriesError").classList.add("show");
        isValid = false;
      }

      // Privacy
      if (!document.getElementById("privacy").checked) {
        document.getElementById("privacyError").classList.add("show");
        isValid = false;
      }

      if (!isValid) {
        if (!scrolledToError) {
          const firstError = document.querySelector(".error-message.show");
          const target = firstError?.closest(".form-group, .checkbox-group") || firstError;
          (target || window).scrollIntoView?.({ behavior: "smooth", block: "start" }) ||
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
        return;
      }
      // --- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº† ---

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
      submitBtn.innerHTML = '<span class="loading"></span> é€ä¿¡ä¸­...';
      submitBtn.disabled = true;

      try {
        // ãƒ•ã‚©ãƒ¼ãƒ å€¤åé›†
        const fd = new FormData(form);
        const firstName      = (fd.get("firstName") || "").trim();
        const lastName       = (fd.get("lastName")  || "").trim();
        const email          = (fd.get("email")     || "").trim();
        const countryCode    = document.getElementById("countryCode").value;
        const rawPhone       = (fd.get("phone")     || "").trim();
        const phone          = countryCode ? `${countryCode}${rawPhone}` : rawPhone;
        const school         = (fd.get("school")    || "").trim();
        const graduationYear = (fd.get("graduationYear") || "").trim();
        const englishLevel   = (fd.get("englishLevel")   || "").trim();
        const schoolType     = (fd.get("schoolType")     || "").trim();
        const personType     = (document.querySelector('input[name="studentOrGuardian"]:checked')?.value || "").trim();
        const privacyAccepted = !!document.getElementById("privacy").checked;
        const lineDisplayName = (document.getElementById("lineDisplayName")?.value || "").trim();
        const prefecture     = (fd.get("prefecture") || "").trim();
        const desiredCountries = Array.from(document.querySelectorAll('input[name="desiredCountries"]:checked')).map(el => el.value);
        
        // User Agent ã®å–å¾—
        const userAgent = navigator.userAgent;

        // ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰æ§‹ç¯‰ç”¨é–¢æ•°
        const createPayload = (uid) => ({
          firstName, lastName, email, phone, school, graduationYear, englishLevel, schoolType,
          desiredCountries, studentOrGuardian: personType, privacy: privacyAccepted,
          lineUserId: uid || "",
          lineDisplayName, prefecture, userAgent
        });

        // 1. LINE ID å–å¾—è©¦è¡Œ
        let lineUserId = "";
        if (typeof liff !== "undefined") {
           // ã¾ãšæ—¢å­˜ã®ãƒˆãƒ¼ã‚¯ãƒ³ç­‰ã‚’ç¢ºèª
           if (liff.getDecodedIDToken && liff.getDecodedIDToken()?.sub) {
             lineUserId = liff.getDecodedIDToken().sub;
           }
           // ãªã‘ã‚Œã°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚’è©¦ã¿ã‚‹ (ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯)
           if (!lineUserId && liff.isLoggedIn()) {
             try {
               const profile = await liff.getProfile().catch(() => null);
               if (profile?.userId) lineUserId = profile.userId;
             } catch (e) {}
           }
        }

        // 2. IDæœ‰ç„¡ã«ã‚ˆã‚‹åˆ†å²
        if (!lineUserId) {
          // --- IDå–å¾—å¤±æ•—æ™‚ ---
          const errorPayload = createPayload(""); // ç©ºã®ID
          
          // (A) ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§GASã¸é€ä¿¡ (ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç”¨)
          sendPayloadToSecondaryEndpoint(errorPayload);
          
          // (B) ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
          const modal = document.getElementById("errorModal");
          const uaBox = document.getElementById("uaContent");
          const forceBtn = document.getElementById("forceSubmitBtn");
          const retryBtn = document.getElementById("retryBtn");

          uaBox.textContent = userAgent; // UAã‚’è¡¨ç¤º
          modal.classList.add("show");
          
          // ãƒœã‚¿ãƒ³ã‚’é€šå¸¸ã®è¡¨ç¤ºã«æˆ»ã—ã¦ãŠãï¼ˆè£ã§ã¯disabledã®ã¾ã¾ã«ã—ãªã„ï¼‰
          submitBtn.innerHTML = "é€ä¿¡ã™ã‚‹";
          submitBtn.disabled = false;

          // ã€Œå†èª­ã¿è¾¼ã¿ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          retryBtn.onclick = () => {
             modal.classList.remove("show");
             saveAndReload();
          };

          // ã€Œé€ä¿¡ã™ã‚‹ï¼ˆå¼·åˆ¶ï¼‰ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
          forceBtn.onclick = () => {
             modal.classList.remove("show");
             // æ—¢ã« (A) ã§é€ä¿¡æ¸ˆã¿ã ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼å®Œäº†ã®ãŸã‚ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹
             // å¿µã®ãŸã‚ã‚‚ã†ä¸€åº¦é€ã£ã¦ã‚‚è‰¯ã„ãŒã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã ã‘ã§ååˆ†
             redirectToThankYouPage(errorPayload);
          };
          
          // ã“ã“ã§å‡¦ç†ä¸­æ–­ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å¾…ã¡ï¼‰
          return;

        } else {
          // --- IDå–å¾—æˆåŠŸæ™‚ (é€šå¸¸ãƒ•ãƒ­ãƒ¼) ---
          const successPayload = createPayload(lineUserId);
          
          sendPayloadToSecondaryEndpoint(successPayload);
          redirectToThankYouPage(successPayload);
        }

      } catch (error) {
        console.error("Submission error:", error);
        alert("é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        submitBtn.innerHTML = "é€ä¿¡ã™ã‚‹";
        submitBtn.disabled = false;
      }
    });

    // ====== ç°¡æ˜“ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼ (Bluræ™‚) ======
    document.querySelectorAll("input, select").forEach(el => {
      el.addEventListener("blur", () => {
        const err = document.getElementById(el.id + "Error");
        if (!err) return;
        if (!el.value.trim()) err.classList.add("show");
        else err.classList.remove("show");
      });
    });
    document.querySelectorAll('input[name="studentOrGuardian"]').forEach(el => {
      el.addEventListener("change", () => {
        document.getElementById("studentOrGuardianError").classList.remove("show");
      });
    });
  </script>

</body>
</html>
