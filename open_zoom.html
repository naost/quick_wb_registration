<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<button id="open">Zoomを外部ブラウザで開く</button>
<div id="status" style="font:14px/1.6 system-ui;margin-top:8px;"></div>

<script>
(async () => {
  const status = (t) => (document.getElementById('status').textContent = t || "");

  await liff.init({ liffId: "2007173778-oD2Wx7BE" }).catch(e => {
    status("LIFF初期化に失敗: " + (e?.message || e));
  });

  // URLを決定（?u= があれば優先、なければ id/tk/uuid から組み立て）
  const u = new URL(location.href);
  const urlFromU = u.searchParams.get("u");
  const id   = u.searchParams.get("id");
  const tk   = u.searchParams.get("tk");
  const uuid = u.searchParams.get("uuid");
  const built = (id && tk && uuid)
    ? `https://zoom.us/w/${encodeURIComponent(id)}?tk=${encodeURIComponent(tk)}&uuid=${encodeURIComponent(uuid)}`
    : null;
  const zoomWebUrl = urlFromU || built;

  if (!zoomWebUrl) {
    status("必要なパラメータ（?u= または id/tk/uuid）が不足しています。");
    document.getElementById('open').disabled = true;
    return;
  }

  document.getElementById('open').addEventListener('click', () => {
    status("外部ブラウザを開いています…");
    let tried = false;

    // 1) LIFFの外部ブラウザオープン（最優先：iOSでもうまくいくケース多数）
    try {
      if (typeof liff !== "undefined" && liff.openWindow) {
        tried = true;
        liff.openWindow({ url: zoomWebUrl, external: true });
      }
    } catch (_) {}

    // 2) window.open フォールバック（iOSの一部で有効）
    setTimeout(() => {
      // 1 が効いていれば多くはここに来ないが、念のため
      const w = window.open(zoomWebUrl, "_blank", "noopener,noreferrer");
      if (w) return; // 成功

      // 3) 最終フォールバック：同一タブ遷移
      setTimeout(() => {
        location.href = zoomWebUrl;
      }, 50);
    }, 150);
  });
})();
</script>
