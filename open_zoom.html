<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
  <title>Open Zoom (LIFF Stories)</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { margin:0; height:100%; overflow:hidden; background:#000; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, sans-serif; }

    #app { position:fixed; inset:0; background:#000; overflow:hidden; touch-action:pan-y; }
    .slides {
      display:flex; width:100%; height:100%;
      transition: transform 320ms ease;
      will-change: transform;
    }
    .slide {
      position:relative; flex: 0 0 100%; height:100%;
      display:grid; place-items:center; background:#000;
    }
    .slide img {
      width:100vw; height:100vh; object-fit:cover; object-position:center;
      user-select:none; -webkit-user-drag:none; pointer-events:none;
    }

    .tap-zone { position:absolute; top:0; bottom:0; width:50%; }
    .tap-left  { left:0; }
    .tap-right { right:0; }

    .dots {
      position:absolute; left:0; right:0; top:env(safe-area-inset-top, 12px);
      display:flex; gap:6px; justify-content:center; padding:12px 16px; pointer-events:none;
    }
    .dot {
      flex:0 0 auto; width:16vw; max-width:120px; height:3px; border-radius:999px; background:#3a3a3a;
      overflow:hidden;
    }
    .dot > b {
      display:block; height:100%; width:0%;
      background:#fff; transition: width 240ms linear;
    }

    .hint {
      position:absolute; left:0; right:0; bottom:calc(env(safe-area-inset-bottom, 12px));
      text-align:center; font-size:12px; color:#ccc; opacity:.9; pointer-events:none;
    }
    .hidden { display:none !important; }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div id="app" aria-live="polite">
    <div class="dots" id="dots" aria-hidden="true">
      <span class="dot"><b></b></span>
      <span class="dot"><b></b></span>
      <span class="dot"><b></b></span>
      <span class="dot"><b></b></span>
      <span class="dot"><b></b></span>
    </div>

    <div class="slides" id="slides" role="listbox" aria-label="ストーリー">
      <section class="slide" role="option" aria-selected="true">
        <img id="img1" alt="slide 1" />
        <div class="tap-zone tap-left"  data-action="prev" aria-label="前へ"></div>
        <div class="tap-zone tap-right" data-action="next" aria-label="次へ"></div>
      </section>
      <section class="slide" role="option" aria-selected="false">
        <img id="img2" alt="slide 2" />
        <div class="tap-zone tap-left"  data-action="prev" aria-label="前へ"></div>
        <div class="tap-zone tap-right" data-action="next" aria-label="次へ"></div>
      </section>
      <section class="slide" role="option" aria-selected="false">
        <img id="img3" alt="slide 3" />
        <div class="tap-zone tap-left"  data-action="prev" aria-label="前へ"></div>
        <div class="tap-zone tap-right" data-action="next" aria-label="次へ"></div>
      </section>
      <section class="slide" role="option" aria-selected="false">
        <img id="img4" alt="slide 4" />
        <div class="tap-zone tap-left"  data-action="prev" aria-label="前へ"></div>
        <div class="tap-zone tap-right" data-action="next" aria-label="次へ"></div>
      </section>
      <section class="slide" role="option" aria-selected="false">
        <img id="img5" alt="slide 5" />
        <div class="tap-zone tap-left"  data-action="prev" aria-label="前へ"></div>
        <div class="tap-zone tap-right" data-action="next" aria-label="次へ"></div>
      </section>
    </div>

    <p class="hint" id="hint">右タップ／左へスワイプで次へ、左タップ／右へスワイプで戻る</p>
  </div>

  <script>
    (async () => {
      // ===== 0) クエリ取得 & Zoom URL 構築（最優先で実行） =====
      const url = new URL(location.href);
      const q = (k) => url.searchParams.get(k);

      const confno = (q("id") || "").trim();
      const tk     = q("tk");
      const uuid   = q("uuid");

      let zoomUrl = "";
      if (confno) {
        zoomUrl = `https://zoom.us/w/${encodeURIComponent(confno)}`;
        const sp = new URLSearchParams();
        if (tk)   sp.set("tk", tk);
        if (uuid) sp.set("uuid", uuid);
        const qs = sp.toString();
        if (qs) zoomUrl += `?${qs}`;
      }
      const FALLBACK_URL = "https://www.crimsoneducation.org/ja";
      const targetUrl = zoomUrl || FALLBACK_URL;

      // ===== 0.5) UA が LINE でなければ即リダイレクト =====
      // LINE in-app browser の UA には "Line" or "LINE" が含まれます。LIFF環境でもUAに"Line"が入るのが一般的。
      const ua = navigator.userAgent || "";
      const isLineUA = /\bLine\b/i.test(ua) || /\bLIFF\b/i.test(ua);
      if (!isLineUA) {
        // 通常ブラウザ：そのままZoom（またはFallback）へ
        try { window.location.replace(targetUrl); }
        catch { window.location.href = targetUrl; }
        return; // 以降のストーリーUIは実行しない
      }

      // ===== 1) LIFF 初期化（LINE 内のみ） =====
      try {
        await liff.init({ liffId: "2007173778-oD2Wx7BE" });
      } catch (e) {
        console.error("LIFF init error:", e);
        // LIFF初期化に失敗した場合も即リダイレクトでフォールバック
        try { window.location.replace(targetUrl); } catch { window.location.href = targetUrl; }
        return;
      }

      // ===== 2) 画像セット（指定がなければ Storyblok 既定） =====
      const images = [
        q("img1") || "https://a.storyblok.com/f/64062/1080x1920/a4cfd8581e/how_to_open_zoom_1.jpg",
        q("img2") || "https://a.storyblok.com/f/64062/1080x1920/ac096ea302/how_to_open_zoom_2.jpg",
        q("img3") || "https://a.storyblok.com/f/64062/1080x1920/6f359ca9e0/how_to_open_zoom_3.jpg",
        q("img4") || "https://a.storyblok.com/f/64062/1080x1920/a3fb4b08d6/how_to_open_zoom_4.jpg",
        q("img5") || "https://a.storyblok.com/f/64062/1080x1920/13fb6c2e02/how_to_open_zoom_5.jpg",
      ];
      images.forEach((src, i) => {
        const el = document.getElementById(`img${i+1}`);
        if (el) el.src = src;
        const im = new Image(); im.src = src;
      });

      // ===== 3) スライド制御 =====
      const slidesEl = document.getElementById("slides");
      const dotBars = Array.from(document.querySelectorAll(".dot > b"));
      const hints = document.getElementById("hint");

      let idx = 0;               // 0..4
      const last = images.length - 1;
      let didRedirect = false;

      function openWebinar() {
        try {
          if (typeof liff !== "undefined" && liff.isInClient && liff.isInClient()) {
            // LINE内 → 外部ブラウザでZoomを開く
            liff.openWindow({ url: targetUrl, external: true });
          } else {
            // 念のため
            window.location.replace(targetUrl);
          }
        } catch (e) {
          window.location.href = targetUrl;
        }
      }

      function maybeRedirect() {
        if (!didRedirect && idx === last) {
          didRedirect = true;
          openWebinar();
        }
      }

      function render() {
        slidesEl.style.transform = `translateX(${-idx * 100}%)`;
        const options = slidesEl.querySelectorAll('[role="option"]');
        options.forEach((opt, i) => opt.setAttribute("aria-selected", String(i === idx)));
        dotBars.forEach((b, i) => b.style.width = i <= idx ? "100%" : "0%");
        if (idx > 0) hints.classList.add("hidden");
        maybeRedirect();
      }

      function next() { if (idx < last) { idx++; render(); } }
      function prev() { if (idx > 0)    { idx--; render(); } }

      render();

      // ===== 4) 入力操作（タップ／スワイプ／キーボード） =====
      slidesEl.addEventListener("click", (ev) => {
        const t = ev.target.closest(".tap-zone");
        if (!t) return;
        (t.dataset.action === "next") ? next() : prev();
      }, { passive: true });

      let startX = 0, startY = 0, isTouch = false, moved = false, startTime = 0;
      function onStart(x, y) {
        isTouch = true; moved = false; startX = x; startY = y; startTime = Date.now();
      }
      function onMove(x, y) {
        if (!isTouch) return;
        const dx = x - startX, dy = y - startY;
        if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 8) moved = true;
      }
      function onEnd(x) {
        if (!isTouch) return; isTouch = false;
        const dx = x - startX;
        const dt = Date.now() - startTime;
        const width = window.innerWidth;

        if (moved && Math.abs(dx) > 50) { dx < 0 ? next() : prev(); return; }
        if (!moved && dt < 250) { (x < width * 0.33) ? prev() : next(); }
      }

      slidesEl.addEventListener("touchstart", (e) => {
        const t = e.changedTouches[0]; onStart(t.clientX, t.clientY);
      }, { passive: true });
      slidesEl.addEventListener("touchmove", (e) => {
        const t = e.changedTouches[0]; onMove(t.clientX, t.clientY);
      }, { passive: true });
      slidesEl.addEventListener("touchend", (e) => {
        const t = e.changedTouches[0]; onEnd(t.clientX);
      }, { passive: true });

      let mouseDown = false;
      slidesEl.addEventListener("mousedown", (e) => { mouseDown = true; onStart(e.clientX, e.clientY); });
      slidesEl.addEventListener("mousemove", (e) => { if (mouseDown) onMove(e.clientX, e.clientY); });
      slidesEl.addEventListener("mouseup",   (e) => { if (mouseDown) { onEnd(e.clientX); mouseDown = false; }});
      slidesEl.addEventListener("mouseleave",(e) => { if (mouseDown) { mouseDown = false; isTouch = false; }});

      window.addEventListener("keydown", (e) => {
        if (e.key === "ArrowRight") next();
        if (e.key === "ArrowLeft")  prev();
      });

      window.addEventListener("resize", () => { requestAnimationFrame(render); });
    })();
  </script>
</body>
</html>
