<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>LIFF 外部ファイルテスト</title>
  <style>
    body { font:14px/1.6 system-ui, sans-serif; padding:20px; background:#fafafa; }
    #log { border:2px solid red; padding:12px; min-height:120px; background:#fff; white-space:pre-wrap; }
    button { margin-top:12px; padding:8px 12px; border:1px solid #ccc; border-radius:6px; }
  </style>
</head>
<body>
  <h2>外部ファイル LIFF テスト</h2>
  <div id="log">[ここにログが出ます]</div>
  <button id="btnInit">LIFF 初期化</button>
  <button id="btnLogin">LINE にログイン</button>
  <button id="btnLogout">ログアウト</button>

  <script>
  (function(){
    const LIFF_ID = "2007173778-2MXG8mQY";
    const THANKYOU_URL = "https://www.crimsoneducation.org/ja/thank-you/line-ty";
    const logEl = document.getElementById("log");
    const log = msg => { logEl.textContent += "\\n" + msg; console.log(msg); };

    // URLクエリから q1 を取得
    const urlParams = new URLSearchParams(location.search);
    const q1 = urlParams.get("q1") || "";

    async function loadScript(src){
      return new Promise((resolve,reject)=>{
        const s=document.createElement("script");
        s.src=src; s.async=true;
        s.onload=resolve;
        s.onerror=()=>reject(new Error("SDK load error"));
        document.head.appendChild(s);
      });
    }

    async function initLiff(){
      try{
        await loadScript("https://static.line-scdn.net/liff/edge/2/sdk.js");
        log("✅ SDK loaded");
        await liff.init({ liffId: LIFF_ID });
        log("✅ liff.init OK");
        log("isLoggedIn=" + liff.isLoggedIn());

        if (liff.isLoggedIn()){
          await afterLogin();
        }
      }catch(e){
        log("❌ init error: " + (e.message||e));
      }
    }

    async function afterLogin(){
      try{
        const profile = await liff.getProfile();
        log("✅ got profile: " + profile.userId);

        // lineid と q1 を thank-you ページへ渡す
        const redirectUrl = new URL(THANKYOU_URL);
        redirectUrl.searchParams.set("lineid", profile.userId);
        if (q1) redirectUrl.searchParams.set("wb", q1);

        log("➡ redirect to " + redirectUrl.toString());
        location.href = redirectUrl.toString();
      }catch(e){
        log("❌ profile error: " + (e.message||e));
      }
    }

    document.getElementById("btnInit").onclick = initLiff;
    document.getElementById("btnLogin").onclick = () => {
      try{
        liff.login({ redirectUri: location.href });
        log("→ liff.login 呼び出し");
      }catch(e){ log("login error: " + (e.message||e)); }
    };
    document.getElementById("btnLogout").onclick = () => {
      try{
        liff.logout();
        log("→ logout 呼び出し / 再読み込みしてください");
      }catch(e){ log("logout error: " + (e.message||e)); }
    };

    // ページ読み込み時に基本情報
    log("location.href = " + location.href);
    log("q1 = " + q1);
  })();
  </script>
</body>
</html>
